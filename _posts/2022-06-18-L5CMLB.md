---
layout:     post
title:     L5/CMLB寻址调研
subtitle:   基础知识
date:       2022-06-18
author:     ldf
header-img: img/post-bg-distribute01.png
catalog: true
tags:
    - QQ
    - 分布式
---

# L5/CMLB

用户或服务间的调度分外网调度和内网调度。

- 外网调度有三种方式：基于域名解析的GSLB域名调度；QQ的IP调度和APP的WNS（内部代号维纳斯）调度。

- 内网服务间调度通过L5和**CMLB**内网名字服务实现。

基本工作原理：

基于机器初始配置信息，通过自适应算法，以两个关键指标（请求成功率和请求延时）为依据，周期性计算出每个被调机器的权重，再使用高效的配额算法分配各个主调机器的访问路由，主调机器上的业务进程通过API来取得这些路由，调用结束时通过API来反馈路由的好与坏。

一个工程师从织云（内部自动化运维系统的代号）上通过一键式操作就可以完成全网和内网调度过程。调度平滑，用户无感知，千万级用户调度可以在30分钟内实现。

![CLB传统负载均衡](https://raw.githubusercontent.com/BBQldf/PicGotest/master/20220624103116.png)

CMLB：使用agent拉取远端配置ip列表，本地调用sdk获取最适合的ip和程序。

CMLB，comm load balance system，通用负载均衡系统。是一个具有路由寻址、负载均衡的命名服务系统。CMLB实现了同IDC、同城、同国、同洲级别就近寻址功能；支持IP静态权重寻址，并支持**寻址调用方根据回包统计结果动态调整目标IP的权重或禁用不可用IP**。

![](https://raw.githubusercontent.com/BBQldf/PicGotest/master/20220624103107.png)

**核心——负载均衡：**

- 负载均衡的层次，TCP 协议和 UDP 协议；HTTP 协议和 HTTPS协议；

- 负载均衡监听器，可以监听负载均衡实例上的四层请求（即OSI网络协议模型第四层传输层），并将这些请求分发至后端服务器进行处理。四层转发能力需要在具体软件的配置文件，进行配置。

- 负载均衡端口：负载均衡器对外或对内提供服务时，接收请求的前端端口。用户可以为下列 TCP 端口执行负载均衡：21（FTP）、25（SMTP）、80（Http）、443（Https），以及 1024-65535等端口。

- 后端服务器端口：后端服务器接受负载均衡分发流量的端口。在同一个负载均衡中，一个负载均衡端口可以对应多个后端服务器端口。

腾讯云的四层转发的**健康检查机制**是，由负载均衡器向配置中指定的服务器端口发起访问请求，如果端口访问正常则视为后端服务器运行正常，否则视为后端服务器运行异常。对于TCP的业务，使用SYN包进行探测。对于UDP业务，使用ping进行检查。（**这一步分很想yuanSun师兄的工作**）

- 响应超时时间： 2-60 秒
- 检查间隔： 5-300 秒
- 不健康阀值：2-10 次 （健康后端服务器出现此指定次数响应超时后，视为不健康）
- 健康阀值：2-10 次（不健康后端服务器出现此指定次数响应超时后，视为健康）

这里有四点不确定：

1. 判定一个用户是否~~健康~~连通率是看他的请求失败率？那这个是说一个用户会不断请求？用户保持通话这种也是不断请求？所以，这种请求到底是指什么？是什么场景下他会不断请求？
2. yuanSun师兄提到要每隔几秒就统计一下前十分钟的请求失败率，那这个涉及到数据的暂存和丢失，是用什么存储？Redis？
3. 然后，什么叫做请求失败？是建联失败？请求方网络不佳？被请求方IP:PORT不对？
4. 还有就是这里不健康的状态之后，要屏蔽一些ip:port。但是这里似乎还和**logen师兄**有点关联？logen师兄好像是一个兜底的服务，会给用户发一些随机的ip:port(ip是正确的，但是port是随机的)，这是在干嘛？我其实没听懂。（是为了防止服务器过载，然后随机丢弃了一些用户请求？这似乎不太合理）



**负载流量分配**

腾讯云四层转发能力，使用加权轮询的分流方式，流量经负载均衡器后按权重比例分配到不同后端服务器上。后端服务器的权重默认为10，可设置0-100范围内的整数。自建负载均衡，也可以参照该实现方法的思想，自己实现负载分配方案。（**这一部分很像xiaodao师兄的工作，负责负载服务器的启动，监控和权重分配**）

但是我有两点不确定？

1. 我们的负载均衡算法，随机算法和轮询算法应该是不太会用。是一致性哈希算法？还是基于权重的算法？（权重应该也不是静态的吧，除了预先配置的静态权重，请求成功率和请求延时会参与权重分配吗？但是这个分配难道不会导致服务倾斜吗？即，出现正反馈——好的服务器会快速吸纳用户，然后请求成功率又下降？）
2. 新的服务器启动之后，老服务器的服务是怎么迁移过去的？怎么才能保证流畅？

PS：QQ是怎么自动检查并告警的？我看到大家用到了很多监控模块。




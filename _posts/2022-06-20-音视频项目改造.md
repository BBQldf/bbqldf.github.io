---
layout:     post
title:     音视频项目重构1
subtitle:   初探
date:       2022-06-20
author:     ldf
header-img: img/post-bg-vedio.jpg
catalog: true
tags:
    - 音视频项目重构
---


# 音视频项目重构1

> 2022-06-20，项目理解与思考。
>
> 背景：
>
> 用户上线有个记录（上游没有更多的服务了），我们要把分发到下游上线推送服务。

## 一、目标

完成下面两个模块的上线（部署），排错，优化，及重构。

1. **多人音视频上线推送分发器（核心）**：（自己既是接收器，也是分发器）每个分发服务器从login_client中拉取全量用户信息，然后提取属于自己的服务信息，并分发给下游上线推送服务

1. **多人音视频上线推送**：接收来自分发服务推送的上线记录，然后查询用户所在群、讨论组、组织等的通话记录，下发对应的s2c消息（redis，imAgent等）

![](https://raw.githubusercontent.com/BBQldf/PicGotest/master/image-20220620201435850.png)

### 1、部署-自测

1. 理解两个源码的编码逻辑，各个func的功能和调用关系
2. 先看分发器distributor，再看推送模块

### 2、排错

> "多人音视频上线推送"中存在redis创建大量的内存但是不回收，导致内存泄漏。（最后内存回收时，会触发抖动）

先block掉，在重构的时候同步考虑

### 3、优化（核心）

1. 原始distributor的分发逻辑是写死，按照1/2/3...讲用户信息区分好，然后由固定的机器去启动。——>现在要求能够动态地划分用户；动态有两方面的：
   1. 分发的逻辑：支持分发器的扩缩容，并且扩缩容之后，各个机器之间的负载要均衡
   2. 容灾的能力：如果A机器挂掉之后，A上的队列要能够由B/C机器去承担；A机器再次启动以后，要能够注册到一个”分发调度器“中，重新安排分发逻辑。

**目前考虑的几个问题：**

1. login_client的数据（包括控制模块）是否要和分发机器的逻辑一起上云？
2. 怎么判断分发机器挂掉了？——可以考虑加一个名字服务，里面有心跳机制。即，每一个分发机器怎么感知到其余节点的销毁和重建？（上游没有其余的服务）
3. login_client数据量和分发机器处理能力之间的关系：e.g.,login_client的数据量是10000人/s，但是每个分发机器的处理能力只有100人/s，那就要有大约10台机器。（如果是分布式锁，锁的竞争就会很频繁）
4. 当A机器（在处理字段1）挂掉之后，B机器被分派到接着处理字段1，应该从哪里开始？是重新开始？还是在A机器标注的offset开始？
   1. 这个问题即考虑——通知类型的数据，是否需要考虑做冗余？或者是可以直接丢弃？
5. A机器挂掉后，再次启动的时候，他应该怎么怎么处理？
   1. 稳定版：A再次启动，还是分配给他挂掉之前的字段，类似于固定了
   2. 动态版：A再次启动，就相当于是一个新的机器（类比一个新的进程过来竞争）——比较倾向于这个，因为既然都重启了，机器上就什么都没有了，再处理之前的分配也没有必要。

针对这几个问题去调研。

### 4、重构

C++ ——> Go，~~这个最后再处理了。~~

2022-06-20讨论完，直接重构“多人音视频上线推送分发器”模块。

------


---
layout:     post
title:    QQ音视频通话的传输安全性
subtitle:   扩展学习
date:       2022-08-20
author:     QQ
header-img: img/post-bg-vedio.jpg
catalog: true
tags:
    - QQ
    - 安全
---


## QQ音视频通话的传输安全性

### 双人通话

#### 逻辑层信令通道

**安全。**
依赖于SSO通道的加密特性。该特性类似于SSL层的功能：客户端在登录时和SSO server通过非对称加密协商交换对称加密所需的密钥，之后客户端和SSO之间的传输通道都使用该密钥进行加密解密。

#### 引擎层信令通道和媒体通道

**不安全。**当前未启用加密特性，启用后则可实现传输安全功能（**需验证**）。
该加密特性的具体实现为：

1. 策略服务器（为双端分别）生成密钥KA，同时将KA作为输入参数之一，使用对称加密算法以及一个固定写死的密钥KB，生成签名S。通过逻辑层信令通道（sso通道）向双端下发各自的密钥KA、签名S。
2. 客户端收到密钥KA和签名S，所有的**引擎层信令包体**（信令包头不加密）、**媒体数据的房间层包体**（媒体数据房间层包头不加密），都会使用KA加密。另外对于进房信令（CMD_GET_IN_REQ），还会带上签名S。
3. 流控服务器收到进房信令（CMD_GET_IN_REQ）时，从包头拿到签名S，使用固定写死的密钥KB，解密签名S得到密钥KA，保存在用户信息中。后续所有来自该用户的信令，都使用该密钥KA解密得到信令包体。
4. 客户端收到媒体数据时，通过对端的密钥KA，解密得到媒体数据房间层包体。

以上加密特性是否启用，由双人通话策略服务器的一个远程配置决定，**当前（2022.07）该特性未启用。**

### 多人通话

#### 逻辑层信令通道

**安全。**
和双人通话相同，略。

#### 引擎层信令通道和媒体通道

**不安全。未实现任何加密特性。**

## WebRTC的传输安全性

![enter image description here](https://iwiki.woa.com/download/attachments/1981192303/image-1658139130681.png?version=1&modificationDate=1658139130775&api=v2)

### 信令通道

WebRTC标准未针对信令通道做规范限制。信令通道的传输安全性依赖于厂商的实现，一般会使用TLS/SSL保证。

### 媒体通道、端对端数据通道

1. 通过ICE过程建立端对端传输通道，每个通道建立后会进行DTLS握手。如果是端对端数据通道（RTCDataChannel），此时已建立完成，端对端的非媒体数据即可利用该基于DTLS协议的RTCDataChannel安全传输。
2. 针对媒体通道，双端还需要交换SRTP的密钥。旧版和新版的WebRTC的SRTP密钥交换方案有所不同。旧版使用的是SDES方案，即通过信令通道的SDP协议直接交换，也就是说，**SDES方案会导致媒体通道的传输安全性完全依赖于信令通道的传输安全性，而后者是不受WebRTC标准控制的**。新版WebRTC默认使用DTLS-SRTP方案，即SRTP密钥直接通过1中DTLS握手完毕的端对端传输通道交换。
3. 双端各自拿到SRTP密钥后，即可应用于媒体数据（RTP payload）的加密解密。

## QQ音视频通话和WebRTC的传输安全性方案对比

### 相似

QQ双人通话的方案某种程度上类似于旧版WebRTC的SDES方案，即通过（逻辑层）信令通道交换媒体通道的密钥。

### 区别

- QQ双人通话逻辑层信令通道的加密特性是基于自研的私有协议，不是基于标准的TLS/SSL协议；WebRTC对于信令通道未做规定。
- QQ双人通话在架构设计上还存在“引擎层信令通道”，即客户端和流控服务器的信令直接由中转服务器中转，而不与逻辑层信令通道统一使用SSO通道，该“引擎层信令通道”的加密特性和媒体通道使用了相同的密钥。而这在WebRTC中未涉及。

## QQ音视频通话传输安全性当前存在的问题（2022.07）

- 双人通话**未启用**加密特性，引擎层信令、媒体数据都可能被中间人**监听、篡改**。
- 多人通话**未实现**加密特性，引擎层信令、媒体数据都可能被中间人**监听、篡改**。
- 双人通话加密特性的实现中，用于生成签名S的密钥KB（不是用于加密信令、媒体数据的密钥KA）是写死在代码中的，**这个密钥属于敏感数据，而当前该代码仓库（qq_av_utils）开源，密钥可能泄露。**

## 参考资料

1. [A Study of WebRTC Security](https://webrtc-security.github.io/) 4.3节
2. [深入浅出SSO——手Q接入层首次完整剖析](https://km.woa.com/group/578/articles/show/217888) 第一章第4节
